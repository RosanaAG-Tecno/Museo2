<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Visor móvil — Teachable Machine (Imagen)</title>
<meta content="#111827" name="theme-color"/>
<style>
    :root { --bg:#0b1220; --fg:#f8fafc; --muted:#9aa4b2; --card:#111827; --accent:#22c55e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: linear-gradient(180deg,#0b1220 0%, #0e1726 40%, #0b1220 100%); color: var(--fg); }
    header { padding: 18px 16px; display:flex; align-items:center; gap:12px; position:sticky; top:0; background:rgba(11,18,32,0.8); backdrop-filter: blur(8px); border-bottom:1px solid rgba(255,255,255,0.06); z-index:10; }
    .badge { font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,0.12); border-radius:999px; color:var(--muted); }
    h1 { font-size:18px; margin:0; }
    main { padding: 14px; max-width: 820px; margin: 0 auto; }
    .card { background:var(--card); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    video, canvas, img { width:100%; max-height: 60vh; background:#000; border-radius:12px; }
    button { width:100%; padding:14px 16px; border-radius:12px; background:#1f2937; color:var(--fg); border:1px solid rgba(255,255,255,0.1); font-weight:600; cursor:pointer; }
    button.primary { background:var(--accent); color:#04120a; border:none; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .grid { display:grid; grid-template-columns:1fr; gap:12px; }
    .pred { background:#0f172a; border:1px solid rgba(255,255,255,0.06); padding:10px; border-radius:12px; }
    .bar { height:8px; background:#0b1220; border-radius:999px; overflow:hidden; }
    .bar > i { display:block; height:100%; width:0%; background:linear-gradient(90deg, #22c55e, #16a34a); }
    .muted { color:var(--muted); font-size: 12px; }
    .field { display:flex; gap:8px; align-items:center; }
    input[type="text"] { flex:1; padding:12px; border-radius:12px; background:#0f172a; color:var(--fg); border:1px solid rgba(255,255,255,0.12); }
    footer { text-align:center; color:var(--muted); font-size:12px; padding:16px; }
  </style>
<!-- Teachable Machine: librería de imagenes -->
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>
<header>
<span class="badge">Teachable Machine · Imagen</span>
<h1>Visor móvil</h1>
</header>
<main class="grid">
<section class="card">
<div class="field" style="margin-bottom:10px">
<input id="modelUrl" placeholder="Pega aquí la URL del modelo (termina en /model.json)" type="text"/>
<button class="primary" id="loadBtn">Cargar modelo</button>
</div>
<p class="muted" style="margin-top:-6px">Ejemplo de formato: https://teachablemachine.withgoogle.com/models/XXXXXX/model.json</p>
<div class="row">
<video id="webcam" muted="" playsinline=""></video>
</div>
<div class="row">
<button id="startBtn">1) Activar cámara</button>
<button disabled="" id="predictBtn">2) Empezar a predecir</button>
<button disabled="" id="stopBtn">Detener</button>
</div>
</section>
<section class="card">
<h2 style="margin:4px 0 8px 0; font-size:16px">Predicciones (Top 3)</h2>
<div class="grid" id="preds"></div>
<p class="muted">Consejos: buena iluminación, sujeta el móvil firme, usa la cámara trasera (modo "environment").</p>
</section>
<section class="card">
<h2 style="margin:4px 0 8px 0; font-size:16px">Subir imagen (alternativa)</h2>
<input accept="image/*" id="fileInput" type="file"/>
<canvas id="preview" style="display:none"></canvas>
<p class="muted">Si no puedes usar la cámara, sube una imagen desde la galería.</p>
</section>
</main>
<footer>Funciona en HTTPS. Para iOS, toca "Activar cámara" para conceder permisos.</footer>
<script>
  let model, maxPredictions = 0, webcamStream = null, loopId = null;
  const webcamEl = document.getElementById('webcam');
  const predsEl = document.getElementById('preds');

  function uiPred(name, prob){
    const pct = Math.round(prob * 100);
    return `<div class="pred"><div style="display:flex;justify-content:space-between"><strong>${name}</strong><span>${pct}%</span></div><div class="bar"><i style="width:${pct}%"></i></div></div>`;
  }

  async function loadModel() {
    const url = document.getElementById('modelUrl').value.trim();
    if(!url || !url.endsWith('/model.json')){
      alert('Pega la URL completa del modelo que termina en /model.json');
      return;
    }
    predsEl.innerHTML = '<p class="muted">Cargando modelo…</p>';
    model = await tmImage.load(url, url.replace('model.json', 'metadata.json'));
    maxPredictions = model.getTotalClasses();
    predsEl.innerHTML = '<p class="muted">Modelo cargado. Activa la cámara o sube una imagen.</p>';
    document.getElementById('predictBtn').disabled = false;
  }

  async function startCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio:false });
      webcamStream = stream; webcamEl.srcObject = stream; await webcamEl.play();
    }catch(e){
      alert('No se pudo acceder a la cámara. Prueba con la opción de subir imagen.');
      console.error(e);
    }
  }

  async function loopPredict(){
    if(!model){ alert('Primero carga un modelo.'); return; }
    if(!webcamStream){ await startCamera(); }
    cancelAnimationFrame(loopId);
    const predict = async () => {
      const preds = await model.predict(webcamEl);
      preds.sort((a,b)=> b.probability - a.probability);
      predsEl.innerHTML = preds.slice(0,3).map(p => uiPred(p.className, p.probability)).join('');
      loopId = requestAnimationFrame(predict);
    };
    predict();
  }

  function stopAll(){
    cancelAnimationFrame(loopId);
    if(webcamStream){
      webcamStream.getTracks().forEach(t=>t.stop());
      webcamStream = null; webcamEl.srcObject = null;
    }
    document.getElementById('predictBtn').disabled = !model;
  }

  async function predictFile(file){
    if(!model){ alert('Primero carga un modelo.'); return; }
    const img = new Image();
    img.onload = async ()=>{
      const c = document.getElementById('preview');
      const ctx = c.getContext('2d');
      c.width = img.width; c.height = img.height; c.style.display='block';
      ctx.drawImage(img,0,0);
      const preds = await model.predict(c);
      preds.sort((a,b)=> b.probability - a.probability);
      predsEl.innerHTML = preds.slice(0,3).map(p => uiPred(p.className, p.probability)).join('');
    };
    img.src = URL.createObjectURL(file);
  }

  document.getElementById('loadBtn').addEventListener('click', loadModel);
  document.getElementById('startBtn').addEventListener('click', startCamera);
  document.getElementById('predictBtn').addEventListener('click', loopPredict);
  document.getElementById('stopBtn').addEventListener('click', stopAll);
  document.getElementById('fileInput').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(f) predictFile(f);
  });

  // Opcional: autocompletar si hay ?model=URL en la query
  const params = new URLSearchParams(location.search);
  const qModel = params.get('model');
  if(qModel){ document.getElementById('modelUrl').value = qModel; }
</script>
<script>
async function loadModelAutomatically() {
    const URL = "https://rosanaag-tecno.github.io/Museo2/model/";
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    const model = await tmImage.load(modelURL, metadataURL);
    const maxPredictions = model.getTotalClasses();

    const webcam = new tmImage.Webcam(200, 200, true);
    await webcam.setup();
    await webcam.play();
    window.requestAnimationFrame(loop);

    document.getElementById("webcam-container").appendChild(webcam.canvas);

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let resultText = "";
        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction = prediction[i].className + ": " + (prediction[i].probability * 100).toFixed(2) + "%";
            resultText += classPrediction + "<br>";
        }
        document.getElementById("label-container").innerHTML = resultText;
    }
}

window.addEventListener("load", loadModelAutomatically);
</script></body>
</html>
